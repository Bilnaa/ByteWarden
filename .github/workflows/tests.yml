name: Java CI with JUnit Tests

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Download Dependencies
      run: |
        mkdir -p lib
        wget https://repo1.maven.org/maven2/junit/junit/4.13.2/junit-4.13.2.jar -P lib/
        wget https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar -P lib/

    - name: Compile
      run: |
        mkdir -p out
        # Compile main classes
        javac -cp "lib/*" -d out src/main/Classes/*.java
        # Compile test classes
        javac -cp "out:lib/*" -d out src/tests/Tests/*.java

    - name: Run tests
      run: |
        # Trouve tous les fichiers *Test.java, les convertit en noms de classes et les exÃ©cute
        TEST_CLASSES=$(find out/Tests -name "*Test.class" | sed 's/out\///' | sed 's/\.class$//' | tr '/' '.')
        java -cp "out:lib/*" org.junit.runner.JUnitCore $TEST_CLASSES

    - name: Generate Test Report
      if: always()
      run: |
        echo "# Test Results" > test-report.md
        echo "\`\`\`" >> test-report.md
        TEST_CLASSES=$(find out/Tests -name "*Test.class" | sed 's/out\///' | sed 's/\.class$//' | tr '/' '.')
        java -cp "out:lib/*" org.junit.runner.JUnitCore $TEST_CLASSES >> test-report.md 2>&1 || true
        echo "\`\`\`" >> test-report.md

    - name: Upload Test Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: test-report.md